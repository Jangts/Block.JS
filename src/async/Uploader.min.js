;tangram.block(['$_/util/bool'],function(pandora,global,imports,undefined){var _=pandora;var doc=global.document;var console=global.console;var XMLHttpRequest=global.XMLHttpRequest;var ActiveXObject=global.ActiveXObject;var FormData=global.FormData;var toRegExp=function(array){var str=array.join('|') str=str.replace(/(\/|\+|\.)/g,'\\$1') @boundary_66_as_preoperator::new RegExp("^("@boundary_69_as_operator::str@boundary_70_as_operator::")$")};var fileTransfer=function(url,form,handlers){var that=this;var onBeforeTransferring=handlers.before;var onAfterTransferring=handlers.after;var onUploadComplete=handlers.done;var onUploadFailed=handlers.fail;var uploader=XMLHttpRequest?new XMLHttpRequest():new ActiveXObject("Microsoft.XMLHTTP") var response=void 0;if(uploader.upload){var onTransferring=handlers.progress;var onSendStart=function(evt){response={lengthComputable:evt.lengthComputable,loaded:evt.loaded,total:evt.total,readyState:uploader.readyState,status:uploader.status,responseText:'Transferring'};_.util.bool.isFn(onBeforeTransferring)@boundary_213_as_operator::onBeforeTransferring.call(that,response)};var onSendProgress=function(evt){response={lengthComputable:evt.lengthComputable,loaded:evt.loaded,total:evt.total,readyState:uploader.readyState,status:uploader.status,responseText:'Transferring'};_.util.bool.isFn(onTransferring)@boundary_221_as_operator::onTransferring.call(that,response)};var onSendComplete=function(evt){response={readyState:uploader.readyState,status:uploader.status,responseText:'Transferred'};_.util.bool.isFn(onAfterTransferring)@boundary_229_as_operator::onAfterTransferring.call(that,response)};var onFailed=function(evt){response={readyState:uploader.readyState,status:uploader.status,responseText:'Transfailed'};_.util.bool.isFn(onUploadFailed)@boundary_237_as_operator::onUploadFailed.call(that,response)};var onTimeout=function(evt){response={readyState:uploader.readyState,status:uploader.status,responseText:'Timeout'};_.util.bool.isFn(onUploadFailed)@boundary_245_as_operator::onUploadFailed.call(that,response)}};var onStateChange=function(){if(this.readyState@boundary_258_as_operator::1){response={lengthComputable:false,loaded:0,total:0,readyState:this.readyState,status:this.status,responseText:'Waiting'};_.util.bool.isFn(onBeforeTransferring)@boundary_253_as_operator::onBeforeTransferring.call(that,response)}@boundary_395_as_preoperator::if(this.readyState@boundary_267_as_operator::2@boundary_269_as_operator::this.readyState@boundary_268_as_operator::3){response={readyState:this.readyState,status:this.status,responseText:'Processing'};_.util.bool.isFn(onAfterTransferring)@boundary_262_as_operator::onAfterTransferring.call(that,response)}@boundary_396_as_preoperator::if(this.readyState@boundary_362_as_operator::4){if(this.status@boundary_278_as_operator::200){response={readyState:this.readyState,status:this.status,responseText:this.responseText };_.util.bool.isFn(onUploadComplete)@boundary_273_as_operator::onUploadComplete.call(that,response)}@boundary_361_as_preoperator::{response={readyState:this.readyState,status:this.status,responseText:this.responseText };_.util.bool.isFn(onUploadFailed)@boundary_329_as_operator::onUploadFailed.call(that,response)}}};if(uploader.upload && @boundary_78_as_preoperator::uploader.onprogress@boundary_79_as_operator::'undefined'){uploader.upload.onloadstart=onSendStart;uploader.upload.onprogress=onSendProgress;uploader.upload.onloadend=onSendComplete;uploader.upload.onerror=onFailed;uploader.upload.ontimeout=onTimeout};uploader.onreadystatechange=onStateChange;uploader.open('POST',url,true) uploader.send(form)};pandora.declareClass('async.Uploader',{Element:null,fileTypeRegExp:null,fileNameRegExp:null,isOnlyFilter:true,_init:function(files,types,suffixs,maxSize){this.files=files;if(_.util.bool.isArr(types)){this.fileTypeRegExp=toRegExp(types)};if(_.util.bool.isArr(suffixs)@boundary_285_as_operator::suffixs.length){this.fileNameRegExp=new RegExp(".("@boundary_168_as_operator::suffixs.join('|')@boundary_169_as_operator::")$")};this.fileMaxSize=@boundary_291_as_preoperator::maxSize@boundary_292_as_operator::'number'?maxSize:1024@boundary_293_as_operator::1024@boundary_294_as_operator::200},checkType:function(doneCallback,failCallback){var result=this.filesChecker(this.files) if(this.isOnlyFilter){var result=this.filesFilter()}@boundary_296_as_preoperator::{var result=this.filesChecker()};if(result[0]){_.util.bool.isFn(doneCallback)@boundary_87_as_operator::doneCallback.call(this,result[1],result[2])}@boundary_297_as_preoperator::{_.util.bool.isFn(failCallback)@boundary_181_as_operator::failCallback.call(this,result[1],result[2])}},filesFilter:function(){var array=[]for(var i=0;i@boundary_369_as_operator::this.files.length;i@boundary_370_as_aftoperator::){if(this.checkSIZE(this.files[i])){if(this.checkTYPE(this.files[i])@boundary_337_as_operator::this.checkEXTN(this.files[i])){array.push(this.files[i])}}};if(array.length@boundary_153_as_operator::0){if(this.files.length@boundary_94_as_operator::array.length){@boundary_93_as_preoperator::[true,array,0]}@boundary_152_as_preoperator::[true,array,1]}@boundary_398_as_preoperator::{@boundary_191_as_preoperator::[false,0,2]}},filesChecker:function(){for(var i=0;i@boundary_319_as_operator::this.files.length;i@boundary_320_as_aftoperator::){if(@boundary_316_as_preoperator::(this.checkTYPE(this.files[i])@boundary_305_as_operator::this.checkEXTN(this.files[i]))){@boundary_193_as_preoperator::[false,this.files[i],0]};if(@boundary_311_as_preoperator::this.checkSIZE(this.files[i])){@boundary_195_as_preoperator::[false,this.files[i],1]}}@boundary_325_as_preoperator::[true,this.files,1]},checkTYPE:function(file){@boundary_96_as_preoperator::this.fileTypeRegExp@boundary_98_as_operator::this.fileTypeRegExp.test(file.type)},checkEXTN:function(file){@boundary_102_as_preoperator::this.fileNameRegExp@boundary_104_as_operator::this.fileNameRegExp.test(file.name)},checkSIZE:function(file){@boundary_108_as_preoperator::file.size@boundary_109_as_operator::this.fileMaxSize},transfer:function(options,method){if(this.files.length@boundary_115_as_operator::this.files.length@boundary_114_as_operator::1){_.async.Uploader.transfer.call(this,this.files[0],options,method)}@boundary_322_as_preoperator::{_.async.Uploader.transfer.call(this,this.files,options,method)}}});pandora.extend(pandora.async.Uploader,{transfer:function(file,options,method){if(_.util.bool.isFile(file)){options=options ||{};options.url=options.url@boundary_348_as_operator::location.href;options.data=options.data ||{};var form=new FormData() for(var i@boundary_120_as_operator::options.data){form.append(i,options.data[i])};if(@boundary_125_as_preoperator::options.filefield@boundary_126_as_operator::'string'){form.append(options.filefield,file)}@boundary_345_as_preoperator::{form.append('myfile',file)};form.append('enctype','multipart/form-data')}@boundary_372_as_preoperator::if(_.util.bool.isFiles(file)){options=options ||{};options.data=options.data ||{};var form=new FormData() for(var i@boundary_131_as_operator::options.data){form.append(i,options.data[i])};if(@boundary_134_as_preoperator::options.filefield@boundary_135_as_operator::'string'){filefield=options.filefield@boundary_133_as_operator::'[]'}@boundary_353_as_preoperator::{filefield='myfile[]'};for(var i=0;i@boundary_140_as_operator::file.length;i@boundary_141_as_aftoperator::){form.append(filefield,file[i])};form.append('enctype','multipart/form-data')}@boundary_373_as_preoperator::if(_.util.bool.isForm(file)){options=options ||{};var form=file;for(var i@boundary_146_as_operator::options.data){form.append(i,options.data[i])}}@boundary_374_as_preoperator::{@boundary_206_as_preoperator::_.debug('Must Give Transfer A File.')};if(method){form.append('http_method',method)};options.url=options.url@boundary_391_as_operator::location.href;options.handlers=options.handlers ||{};fileTransfer.call(this,options.url,form,options.handlers)}});@boundary_412_as_preoperator::_.async.Uploader});