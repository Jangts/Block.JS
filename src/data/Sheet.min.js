;tangram.block(['$_/arr/','$_/obj/','$_/data/Storage'],function(pandora,global,imports,undefined){var _=pandora;var doc=global.document;var console=global.console;var location=global.location;var Storage=_.data.Storage;var queryJSON=_.data.queryJSON;var infs={};var tables={};var metable=new Storage('pandora.data.Table');var namingExpr=/^[A-Z_]\w*$/i;var create=function(tablename,fields,primarykey,constraints){var defaultStorageName='pandora.data.Table.'@boundary_389_as_operator::tablename;@boundary_332_as_preoperator::{ai:0,length:0,name:tablename,fields:fields,pk:primarykey,constraints:constraints,storages:[defaultStorageName]}};var partlen=1000@boundary_576_as_operator::1000@boundary_577_as_operator::5;var update=function(tablename){var storageName=void 0;var mateinfs=infs[tablename]var json=global.JSON.stringify(tables[tablename]) var parts=json.length@boundary_2_as_operator::partlen;var i=0;var storages=[]for(i;i@boundary_184_as_operator::parts;i@boundary_185_as_aftoperator::){storageName='pandora.data.Table.'@boundary_178_as_operator::tablename@boundary_179_as_operator::(i?i:'') storages.push(storageName) new new Storage(storageName).set('data',json.substr(partlen@boundary_173_as_operator::i,partlen))};mateinfs.length=_.obj.length(tables[tablename]) mateinfs.storages=storages;metable.set(tablename,mateinfs)};var check=function(value,constraint){switch(constraint.type){case 'boolean':@boundary_313_as_preoperator::_.arr.has([true,false,1,0],value) case 'object':@boundary_314_as_preoperator::(@boundary_319_as_preoperator::value@boundary_320_as_operator::'object') case 'string':if(@boundary_298_as_preoperator::value@boundary_299_as_operator::'string'){if(constraint.length){if(value.length@boundary_188_as_operator::constraint.length){@boundary_187_as_preoperator::false}};if(constraint.pattern){var patt=new RegExp(constraint.pattern) @boundary_190_as_preoperator::patt.test(value)}@boundary_297_as_preoperator::true}@boundary_315_as_preoperator::false;case 'number':if(@boundary_302_as_preoperator::value@boundary_303_as_operator::'number'){if(constraint.max){if(value.length@boundary_198_as_operator::constraint.length){@boundary_197_as_preoperator::false}};if(constraint.min){if(value.length@boundary_201_as_operator::constraint.min){@boundary_200_as_preoperator::false}}@boundary_301_as_preoperator::true}@boundary_316_as_preoperator::false;default:@boundary_317_as_preoperator::true}};var assign=function(mateinfs,data,_data){pandora.each(mateinfs.fields,function(fieldname,value){if((fieldname@boundary_555_as_operator::mateinfs.pk)@boundary_558_as_operator::data.hasOwnProperty(fieldname)){if(mateinfs.constraints@boundary_503_as_operator::mateinfs.constraints[fieldname]){if(check(data[fieldname],mateinfs.constraints[fieldname])){_data[fieldname]=data[fieldname]}@boundary_498_as_preoperator::{if(@boundary_462_as_preoperator::_data.hasOwnProperty(fieldname)){_data[fieldname]=value}}}@boundary_551_as_preoperator::{_data[fieldname]=data[fieldname]}}@boundary_554_as_preoperator::{if(@boundary_469_as_preoperator::_data.hasOwnProperty(fieldname)){_data[fieldname]=value}}},this);@boundary_572_as_preoperator::_data};pandora.declareClass('data.Sheet',{_init:function(tablename,fields,primarykey,constraints){if(namingExpr.test(tablename)){this.tablename=tablename;if(@boundary_519_as_preoperator::tables[tablename]){var mateinfs=metable.get(tablename) if(@boundary_506_as_preoperator::mateinfs){if(fields){mateinfs=create(tablename,fields,primarykey,constraints) metable.set(tablename,mateinfs)}@boundary_505_as_preoperator::{mateinfs=create(tablename,{'id':0},'id',{}) metable.set(tablename,mateinfs)}};var json='' pandora.each(mateinfs.storages,function(i,storageName){json@boundary_211_as_operator::new new Storage(storageName).get('data')},this);infs[tablename]=mateinfs;@boundary_512_as_preoperator::{tables[tablename]=global.JSON.parse(json)}catch(e){tables[tablename]={}};console.log(mateinfs)}}@boundary_564_as_preoperator::{_.error('Error Tablename')}},add:function(fieldname,value,constraint){var tablename=this.tablename;var mateinfs=infs[tablename]if(@boundary_394_as_preoperator::mateinfs.fields.hasOwnProperty(fieldname)){mateinfs.fields[fieldname]=value=value@boundary_347_as_operator::'' if(constraint@boundary_215_as_operator::constraint.type){mateinfs.constraints[fieldname]=constraint};pandora.each(tables[tablename],function(id,row){row[fieldname]=value},this)}@boundary_392_as_preoperator::this},drop:function(fieldname){var tablename=this.tablename;var mateinfs=infs[tablename]if(fieldname){if(mateinfs.fields.hasOwnProperty(fieldname)){@boundary_351_as_preoperator::mateinfs.fields[fieldname]@boundary_352_as_preoperator::mateinfs.constraints[fieldname]pandora.each(tables[tablename],function(id,row){@boundary_218_as_preoperator::row[fieldname]},this)}@boundary_400_as_preoperator::this};pandora.each(mateinfs.storages,function(i,storageName){new new Storage(storageName).clear(true)},this);metable.set(tablename) @boundary_440_as_preoperator::infs[tablename]@boundary_441_as_preoperator::tables[tablename]@boundary_438_as_preoperator::null},alter:function(fieldname,newname,value){var tablename=this.tablename;var mateinfs=infs[tablename]if(fieldname){if(mateinfs.fields.hasOwnProperty(fieldname)){mateinfs.fields[newname]=value@boundary_358_as_operator::undefined?mateinfs.fields[fieldname]:value;@boundary_356_as_preoperator::mateinfs.fields[fieldname]mateinfs.constraints[newname]=mateinfs.constraints[fieldname]@boundary_357_as_preoperator::mateinfs.constraints[fieldname]pandora.each(tables[tablename],function(id,row){row[newname]=row[fieldname]@boundary_225_as_preoperator::row[fieldname]},this)}@boundary_407_as_preoperator::this}@boundary_445_as_preoperator::this},insert:function(data){var tablename=this.tablename;var mateinfs=infs[tablename]pandora.each(arguments,function(i,data){data=assign(mateinfs,data,{}) data[mateinfs.pk]=@boundary_415_as_preoperator::mateinfs.ai;tables[tablename][mateinfs.ai]=data},this);@boundary_447_as_preoperator::mateinfs.ai},update:function(id,data){var tablename=this.tablename;var mateinfs=infs[tablename]if(id@boundary_420_as_operator::tables[tablename].hasOwnProperty(id)@boundary_421_as_operator::data){tables[tablename][id]=assign(mateinfs,data,tables[tablename][id]) update(tablename)}@boundary_418_as_preoperator::this},select:function(id){var tablename=this.tablename;if(id){rs=[]pandora.each(arguments,function(i,id){if(tables[tablename][id]){rs.push(tables[tablename][id])}},this);@boundary_305_as_preoperator::rs}@boundary_325_as_preoperator::_.obj.toArray(tables[tablename])},delete:function(id){var tablename=this.tablename;if(id){pandora.each(arguments,function(i,id){@boundary_231_as_preoperator::tables[tablename][id]},this)}@boundary_307_as_preoperator::this},fields:function(){var fields={};var mateinfs=infs[this.tablename]if(mateinfs){pandora.each(mateinfs.fields,function(fieldname,value){fields[fieldname]={default:value,constraint:mateinfs.constraints@boundary_367_as_operator::mateinfs.constraints[fieldname],isPKey:fieldname@boundary_366_as_operator::mateinfs.pk }},this);@boundary_451_as_preoperator::fields}@boundary_455_as_preoperator::false},render:function(width,border,context){var that=this;_.ab(['$_/see/see.css','$_/dom/'],function(){var mateinfs=infs[that.tablename]if(mateinfs){if(width){_width=' width="'@boundary_233_as_operator::width@boundary_234_as_operator::'"'}@boundary_428_as_preoperator::{_width=''};if(border){_border=' border="'@boundary_236_as_operator::border@boundary_237_as_operator::'"'}@boundary_429_as_preoperator::{_border=''};var rows=tables[that.tablename]var html='<table class="table" '@boundary_432_as_operator::_width@boundary_433_as_operator::_border@boundary_434_as_operator::'><tbody><tr class="head-row"><th>'@boundary_435_as_operator::mateinfs.pk@boundary_436_as_operator::'</th>' pandora.each(mateinfs.fields,function(fieldname){if(fieldname@boundary_242_as_operator::mateinfs.pk){html@boundary_239_as_operator::'<th>'@boundary_240_as_operator::fieldname@boundary_241_as_operator::'</th>'}},this);pandora.each(rows,function(id,row){html@boundary_309_as_operator::'</tr><tr><td>'@boundary_310_as_operator::id@boundary_311_as_operator::'</td>' pandora.each(row,function(fieldname,value){if(fieldname@boundary_247_as_operator::mateinfs.pk){html@boundary_244_as_operator::'<td>'@boundary_245_as_operator::value@boundary_246_as_operator::'</td>'}},this)},this);html@boundary_431_as_operator::'</tr></tbody></table>' if(context){_.dom.addClass(context,'tangram-see') _.dom.append(context,html)}@boundary_430_as_preoperator::{_.dom.append(doc.body,html)}}@boundary_453_as_preoperator::false})}});pandora.extend(pandora.data.Sheet,{exec:function(str){var matchs=str.match(/^(select|delete|update|insert)([\w\,\*\s]+from\s+|\s+from\s+|\s+into\s+|\s+)([A-Z_]\w*)\s+(.+)/i) if(matchs){var mateinfs=infs[matchs[3]]if(mateinfs){var type=matchs[1]var table='json.'@boundary_543_as_operator::matchs[3]switch(type){case 'select':var sql='select '@boundary_529_as_operator::matchs[2]@boundary_530_as_operator::table@boundary_531_as_operator::' '@boundary_532_as_operator::matchs[4]@boundary_521_as_preoperator::queryJSON(sql,tables) case 'delete':var sql='select * from '@boundary_533_as_operator::table@boundary_534_as_operator::' '@boundary_535_as_operator::matchs[4]var result=queryJSON(sql,tables) if(result.length){var table=new _.data.Sheet(matchs[3]) pandora.each(result,function(i,row){table.delete(row[mateinfs.pk])},this)}@boundary_522_as_preoperator::result.length;case 'update':var mas=matchs[4].match(/^set\s+(\{.+\})\s+(where\s+\(.+\))$/i) if(mas){@boundary_508_as_preoperator::{eval('var data = '@boundary_481_as_operator::mas[1]);if(typeof(data)){var sql='select * from '@boundary_377_as_operator::table@boundary_378_as_operator::' '@boundary_379_as_operator::mas[2]var result=queryJSON(sql,tables) if(result.length){var table=new _.data.Sheet(matchs[3]) pandora.each(result,function(i,row){table.update(row[mateinfs.pk],data)},this)}@boundary_375_as_preoperator::result.length}}catch(e){console.log(e)}}@boundary_523_as_preoperator::0;case 'insert':var mas=matchs[4].match(/^values\s+(\{.+\})\s*$/i) if(mas){@boundary_510_as_preoperator::{eval('var data = ['@boundary_489_as_operator::mas[1]@boundary_490_as_operator::']');if(typeof(data)){var table=new _.data.Sheet(matchs[3]) @boundary_382_as_preoperator::table.insert.apply(table,data)}}catch(e){console.log(e)}}@boundary_524_as_preoperator::0}}}@boundary_546_as_preoperator::false}});@boundary_574_as_preoperator::_.data.Sheet});